product ZAB ERP

table imconsumptionview
  caption "PR JN Advance receive view"
  columns zid,xtrn,xwh,xdate,xchassisno,xgitem,xaccdr,xnote,xacccr,xdesc,xprime

  primary key zid,xtrn,xwh,xdate,xchassisno,xgitem,xaccdr,xnote,xacccr,xdesc,xprime

  foreign key
        zid references zbusiness.zid
  end foreign key

  sql create view imconsumptionview (zid,xtrn,xwh,xdate,xgitem,xtype,xaccdr,xacccr,xprime) ~
                  as Select a.zid, ~
				  CASE WHEN imgl.xtrn='OP--' THEN 'Sales' ~
				  WHEN imgl.xtrn='IS--' THEN 'Inventory Consumption' ~
				  WHEN imgl.xtrn='CWIP' THEN 'Inventory CWIP' ~
				  WHEN imgl.xtrn='SR--' THEN 'Sales Return' ~
				  WHEN imgl.xtrn='RT--' and left(a.xdocnum,4)='TO--' THEN 'Transfer Receive' ~
				  WHEN imgl.xtrn='IT--' and left(a.xdocnum,4)='TO--' THEN 'Transfer Issue' ~
				  WHEN imgl.xtrn='LNRE' THEN 'Loan Receive' ~
				  WHEN imgl.xtrn='LNIS' THEN 'Loan Issue' ~
				  ELSE imgl.xtrn END, ~
				  a.xwh,a.xdate,itm.xgitem,left(a.xdocnum,4),isnull(imgl.xacc,'Debit Account Not Set'), ~
				  isnull(imgl.xacccr,'Creadit Account Not Set'), ~
				  (Select sum(((im.xval/(case when isnull(im.xqty,0)=0 then 1 else im.xqty end))*(im.xqty-isnull(im.xqtybac,0)))) ~
				  from imtrn im join caitem ctm on im.zid=ctm.zid and im.xitem=ctm.xitem ~
				  where a.zid=im.zid and a.xdate=im.xdate and a.xwh=im.xwh and ctm.xgitem=itm.xgitem and  left(a.xdocnum,4)=left(im.xdocnum,4) and ~
				  (isnull(im.xstatusjv,'Open')='Open' or im.xstatusjv='') and left(im.ximtrnnum,2)=left(imgl.xtrn,2) and im.xqty>0) ~
                  from imtrn a ~
				  join caitem itm on a.zid=itm.zid and a.xitem=itm.xitem ~
				  left join imtogli imgl on imgl.zid=a.zid and imgl.xgitem=itm.xgitem and imgl.xtrn=left(a.ximtrnnum,4) ~
				  //left join acmst dr on dr.zid=imgl.zid and dr.xacc=imgl.xacc ~
				  //left join acmst cr on cr.zid=cr.zid and cr.xacc=imgl.xacccr ~
				  WHERE (isnull(a.xstatusjv,'Open')='Open' or a.xstatusjv='') and (left(a.ximtrnnum,2) in ('IS','SR','OP','RT','IT','LN') or left(a.ximtrnnum,4)='CWIP') ~
				  //and a.xstatus='Confirmed' ~
				  group by a.zid,imgl.xtrn,a.xwh,a.xdate,itm.xgitem,left(a.xdocnum,4),isnull(imgl.xacc,'Debit Account Not Set'), ~
				  isnull(imgl.xacccr,'Creadit Account Not Set')

end table
