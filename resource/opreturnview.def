
product ZAB ERP

table opreturnview
  caption "Sales Return View for Enter sales return"
  columns zid,xdornum,xitem,xdesc,xunit,xrate,xqtyord,xvatrate,xdiscdet,xrow
  primary key zid,xdornum,xitem
  foreign key
        zid references zbusiness.zid
  end foreign key

  sql create view opreturnview(zid,xdornum,xitem,xdesc,xunit,xrate,xqtyord,xqtybonus,xvatrate,xdiscdet,xrow) ~	
	
	as select do.zid,do.xdornum,do.xitem,ca.xdesc,do.xunit,do.xrate,sum(do.xqtyord-isnull(temptable.xqtyord,0))as xqtyord,~
	sum(do.xqtybonus-isnull(temptable.xqtybonus,0))as xqtybonus,do.xvatrate,~
	do.xdiscdet,do.xrow from opdodetail do ~
      	inner join caitem ca on do.zid=ca.zid and do.xitem=ca.xitem ~
      	left join(select ch.zid,ch.xordernum,cd.xitem,cd.xdocrow,sum(isnull(cd.xqtyord,0))as xqtyord,sum(isnull(cd.xqtybonus,0))as xqtybonus ~
			from opcrnheader ch ~
			inner join opcrndetail cd on ch.zid=cd.zid and ch.xcrnnum=cd.xcrnnum ~
                  group by ch.zid,ch.xordernum,cd.xitem,cd.xdocrow)temptable on do.xrow=temptable.xdocrow and ~
			do.zid=temptable.zid and do.xdornum=temptable.xordernum ~
			where ca.xstype='Stock-N-Sell' ~
			group by do.zid,do.xdornum,do.xitem,ca.xdesc,do.xunit,do.xrate,do.xvatrate,do.xdiscdet,do.xrow ~
                  having sum((do.xqtyord-isnull(temptable.xqtyord,0)))<>0 ~
		  union all ~


	select do1.zid,do1.xdornum,do1.xitem,ca.xdesc,do1.xunit,do1.xrate,sum(do1.xqtyord-isnull(temptable1.xqtyord,0)-isnull(temptable2.xqtyord,0))as xqtyord,~
	sum(do1.xqtybonus-isnull(temptable1.xqtybonus,0)-isnull(temptable2.xqtybonus,0))as xqtybonus,do1.xvatrate,~
	do1.xdiscdet,do1.xrow from [10.0.0.21].ZABDB.dbo.opdodetail do1 ~
      	inner join caitem ca on do1.zid=ca.zid and do1.xitem=ca.xitem ~

// from current server

      	left join(select ch1.zid,ch1.xordernum,cd1.xitem,cd1.xdocrow,sum(isnull(cd1.xqtyord,0))as xqtyord,sum(isnull(cd1.xqtybonus,0))as xqtybonus ~
			from opcrnheader ch1 ~
			inner join opcrndetail cd1 on ch1.zid=cd1.zid and ch1.xcrnnum=cd1.xcrnnum ~
                  group by ch1.zid,ch1.xordernum,cd1.xitem,cd1.xdocrow)temptable1 on do1.xrow=temptable1.xdocrow and ~
			do1.zid=temptable1.zid and do1.xdornum=temptable1.xordernum ~
// from main server

	      	left join(select ch1.zid,ch1.xordernum,cd1.xitem,cd1.xdocrow,sum(isnull(cd1.xqtyord,0))as xqtyord,sum(isnull(cd1.xqtybonus,0))as xqtybonus ~
			from [10.0.0.21].ZABDB.dbo.opcrnheader ch1 ~
			inner join [10.0.0.21].ZABDB.dbo.opcrndetail cd1 on ch1.zid=cd1.zid and ch1.xcrnnum=cd1.xcrnnum ~
                  group by ch1.zid,ch1.xordernum,cd1.xitem,cd1.xdocrow)temptable2 on do1.xrow=temptable2.xdocrow and ~
			do1.zid=temptable2.zid and do1.xdornum=temptable2.xordernum ~

			where ca.xstype='Stock-N-Sell' ~
			group by do1.zid,do1.xdornum,do1.xitem,ca.xdesc,do1.xunit,do1.xrate,do1.xvatrate,do1.xdiscdet,do1.xrow ~
                  having sum((do1.xqtyord-isnull(temptable1.xqtyord,0)-isnull(temptable2.xqtyord,0)))<>0
	
end table

