USE [ZABDB]
GO
/****** Object:  StoredProcedure [dbo].[zabsp_xlfileuploadtrn]    Script Date: 8/28/2019 3:06:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

--exec zabsp_ca_temp 100010,'zabadmin'

ALTER PROCEDURE [dbo].[zabsp_ca_temp]
				@zid INT,
				@user varchar(150)
AS
	DECLARE  @trn VARCHAR(50),
			@row INT,
			@trnlength INT,
			@year VARCHAR(2),
			@trnnum VARCHAR(50),
			@cus VARCHAR(50),
			@oldcode varchar(250),
			@amt decimal(20, 2),
			@accountname varchar(50)

		SET @trn='CUS-'
		SET @trnlength = 6
		SET @row = 0

	DECLARE cursor_bulk CURSOR FORWARD_ONLY FOR
		SELECT [Account No],Total,[Account Name]
		FROM cacus_aging_temp
		WHERE [Account Name] IS NOT NULL
		
	OPEN cursor_bulk
	FETCH FROM cursor_bulk INTO @oldcode,@amt,@accountname
	WHILE @@FETCH_STATUS = 0
	BEGIN
 


	IF EXISTS(SELECT xoldcode FROM cacus Where xoldcode=@oldcode)  
		BEGIN  
				UPDATE cacus SET xamount=@amt,zauserid=@user,zutime=GETDATE() where xoldcode=@oldcode	
				 print @oldcode		
				 print '----' 
		END  
	ELSE  
		BEGIN  
		print '============='
		SET @row = @row +1
		 print @oldcode	
		print 'Not Exist'
		Print @row

			EXEC Func_getTrn @zid,'Customer Code',@trn,@trnlength, @strVar=@cus OUTPUT
				----SET @trnnum = @trn+CAST(@year AS VARCHAR(2))+RIGHT(@trnnum,8)

print @cus
print '%%%%%%%%%%%%%'
				INSERT INTO cacus(zid,ztime,xcus,xorg,zactive,xgsup,xemail,xoldcode,xamount)
				VALUES(@zid,GETDATE(),@cus,@accountname,1,'Customer','',@oldcode,@amt)		
		END  


		FETCH NEXT FROM cursor_bulk INTO  @oldcode,@amt,@accountname
		END
	CLOSE cursor_bulk
	DEALLOCATE cursor_bulk

